<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omerta 2026 - Values & Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Rajdhani', sans-serif;
        }
        
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        
        @keyframes slide-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes scale-in {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%, #0a0a0a 100%);
            background-attachment: fixed;
        }
        
        .bw-gradient {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.3) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.15);
        }
        
        .card-hover {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
        }
        
        .slide-in {
            animation: slide-in 0.6s ease forwards;
        }
        
        .fade-in {
            animation: fade-in 0.8s ease forwards;
        }
        
        .scale-in {
            animation: scale-in 0.5s ease forwards;
        }
        
        .glow-text {
            text-shadow: 0 0 20px rgba(255,255,255,0.5), 0 0 40px rgba(255,255,255,0.3);
        }
        
        .button-shine {
            position: relative;
            overflow: hidden;
        }
        
        .button-shine::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.6s;
        }
        
        .button-shine:hover::before {
            left: 100%;
        }
        
        .value-up {
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%);
            border-left: 3px solid #4ade80;
        }
        
        .value-down {
            background: linear-gradient(135deg, rgba(248, 113, 113, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
            border-left: 3px solid #f87171;
        }
        
        .input-glow:focus {
            box-shadow: 0 0 0 3px rgba(255,255,255,0.2);
        }
        
        .glass-nav {
            background: linear-gradient(135deg, rgba(20,20,20,0.9) 0%, rgba(40,40,40,0.8) 100%);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .login-box {
            background: linear-gradient(135deg, rgba(30,30,30,0.95) 0%, rgba(15,15,15,0.95) 100%);
            backdrop-filter: blur(30px);
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 30px 60px rgba(0,0,0,0.5), 0 0 100px rgba(255,255,255,0.05);
        }
        
        .continue-btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        
        .continue-btn:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255,255,255,0.2);
        }
        
        .discord-btn {
            background: linear-gradient(135deg, rgba(88, 101, 242, 0.2) 0%, rgba(88, 101, 242, 0.1) 100%);
            border: 1px solid rgba(88, 101, 242, 0.4);
            transition: all 0.3s ease;
        }
        
        .discord-btn:hover {
            background: linear-gradient(135deg, rgba(88, 101, 242, 0.3) 0%, rgba(88, 101, 242, 0.2) 100%);
            border-color: rgba(88, 101, 242, 0.6);
            transform: scale(1.05);
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(30,30,30,0.98) 0%, rgba(15,15,15,0.98) 100%);
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 30px 60px rgba(0,0,0,0.7);
            animation: scale-in 0.3s ease forwards;
        }
        
        .game-link-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.2) 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .game-link-section:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(0,0,0,0.3) 100%);
            border-color: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body class="text-white min-h-screen">
    <!-- Auth Screen -->
    <div id="auth-screen" class="flex flex-col items-center justify-center min-h-screen p-4 gap-8">
        <div class="login-box p-10 rounded-3xl w-full max-w-lg scale-in">
            <div class="text-center mb-10">
                <h1 class="text-7xl font-black mb-3 glow-text font-orbitron tracking-wider">OMERTA</h1>
                <div class="flex items-center justify-center gap-3 mb-6">
                    <div class="h-[2px] w-16 bg-gradient-to-r from-transparent via-white to-transparent"></div>
                    <p class="text-3xl font-bold font-orbitron tracking-widest">2026</p>
                    <div class="h-[2px] w-16 bg-gradient-to-r from-transparent via-white to-transparent"></div>
                </div>
                <p class="text-gray-400 text-lg tracking-wide">AUTHENTICATE TO ACCESS THE MARKET</p>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-gray-400 mb-2 tracking-wide">POLYTORIA ID</label>
                    <input 
                        type="number" 
                        id="polytoria-id" 
                        placeholder="Enter your ID" 
                        class="input-glow w-full px-5 py-4 bg-black/40 rounded-xl border border-white/20 focus:outline-none focus:border-white/40 transition-all text-lg font-medium"
                    >
                </div>
                
                <div class="cf-turnstile flex justify-center" data-sitekey="0x4AAAAAACcvzWqePGZJezeH"></div>
                
                <button 
                    onclick="login()" 
                    class="continue-btn button-shine w-full px-6 py-4 rounded-xl font-bold text-lg tracking-wider font-orbitron"
                >
                    <span class="flex items-center justify-center gap-3">
                        <span>CONTINUE</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                        </svg>
                    </span>
                </button>
            </div>
            
            <div class="mt-8 pt-8 border-t border-white/10">
                <a 
                    href="https://discord.gg/k6Wb7qFRt2" 
                    target="_blank"
                    class="discord-btn flex items-center justify-center gap-3 px-6 py-3 rounded-xl font-semibold tracking-wide"
                >
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                    JOIN DISCORD SERVER
                </a>
            </div>
        </div>
        
        <!-- Game Link Section Below -->
        <div class="w-full max-w-lg slide-in" style="animation-delay: 0.2s;">
            <a 
                href="https://polytoria.com/places/90985" 
                target="_blank"
                class="game-link-section flex items-center justify-between p-6 rounded-2xl transition-all duration-300 card-hover"
            >
                <div class="flex items-center gap-4">
                    <div class="bg-white/10 p-3 rounded-xl">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-400 tracking-wide">PLAY NOW</p>
                        <p class="text-xl font-bold font-orbitron tracking-wide">GAME LINK</p>
                    </div>
                </div>
                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
            </a>
        </div>
    </div>

    <!-- Main Screen -->
    <div id="main-screen" class="hidden min-h-screen fade-in">
        <!-- Navigation -->
        <nav class="glass-nav p-5 shadow-2xl sticky top-0 z-50">
            <div class="container mx-auto flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h1 class="text-4xl font-black glow-text font-orbitron tracking-wider">OMERTA</h1>
                    <p class="text-sm text-gray-400 font-orbitron tracking-widest">2026</p>
                </div>
                <div class="flex flex-wrap items-center gap-6">
                    <div class="text-right">
                        <p class="text-sm text-gray-400 tracking-wide">OPERATOR</p>
                        <p id="username" class="text-lg font-bold"></p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-400 tracking-wide">BALANCE</p>
                        <p id="balance" class="text-2xl font-black font-orbitron"></p>
                    </div>
                    <a 
                        href="https://discord.gg/k6Wb7qFRt2" 
                        target="_blank"
                        class="bw-gradient p-3 rounded-xl hover:bg-white/10 transition-all card-hover"
                    >
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-6 md:p-8">
            <!-- Tab Buttons -->
            <div class="flex gap-4 mb-10">
                <button 
                    onclick="showValues()" 
                    id="values-tab"
                    class="button-shine bw-gradient px-8 py-4 rounded-xl font-bold text-lg tracking-wider font-orbitron transition-all duration-300 hover:bg-white/20"
                >
                    üìä VALUES
                </button>
                <button 
                    onclick="showShop()" 
                    id="shop-tab"
                    class="button-shine bw-gradient px-8 py-4 rounded-xl font-bold text-lg tracking-wider font-orbitron transition-all duration-300 hover:bg-white/20"
                >
                    üõí SHOP
                </button>
            </div>

            <!-- Values Section -->
            <div id="values-section" class="hidden">
                <h2 class="text-4xl font-black mb-8 glow-text font-orbitron tracking-wider">ITEM VALUES</h2>
                <div id="values-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- Shop Section -->
            <div id="shop-section" class="hidden">
                <h2 class="text-4xl font-black mb-8 glow-text font-orbitron tracking-wider">SHOP</h2>
                <div id="shop-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </div>
    </div>

    <!-- Purchase Confirmation Modal -->
    <div id="purchase-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="modal-content p-8 rounded-3xl w-full max-w-md">
            <div class="text-center mb-6">
                <div class="bg-white/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                </div>
                <h3 class="text-3xl font-black mb-2 glow-text font-orbitron tracking-wider">CONFIRM PURCHASE</h3>
                <p class="text-gray-400 tracking-wide">Verify to complete transaction</p>
            </div>
            
            <div class="space-y-4 mb-6">
                <div class="bw-gradient p-4 rounded-xl">
                    <p class="text-sm text-gray-400 mb-1">ITEM</p>
                    <p id="modal-item-name" class="text-xl font-bold tracking-wide"></p>
                </div>
                
                <div class="bw-gradient p-4 rounded-xl">
                    <p class="text-sm text-gray-400 mb-1">PRICE</p>
                    <p id="modal-item-price" class="text-2xl font-black font-orbitron"></p>
                </div>
                
                <div class="cf-turnstile flex justify-center" id="purchase-turnstile" data-sitekey="0x4AAAAAACcvzWqePGZJezeH"></div>
            </div>
            
            <div class="flex gap-3">
                <button 
                    onclick="closePurchaseModal()" 
                    class="flex-1 bw-gradient px-4 py-3 rounded-xl font-bold tracking-wider font-orbitron transition-all duration-300 hover:bg-white/20"
                >
                    CANCEL
                </button>
                <button 
                    onclick="confirmPurchase()" 
                    class="flex-1 continue-btn button-shine px-4 py-3 rounded-xl font-bold tracking-wider font-orbitron"
                >
                    CONFIRM
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let pendingPurchase = null;

        async function login() {
            const polyId = document.getElementById('polytoria-id').value;
            const turnstileToken = document.querySelector('[name="cf-turnstile-response"]')?.value;
            
            if (!polyId || !turnstileToken) {
                alert('‚ö†Ô∏è Please complete all fields');
                return;
            }
            
            const res = await fetch('/api?action=auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ polytoria_id: polyId, turnstile_token: turnstileToken })
            });
            
            const data = await res.json();
            
            if (data.success) {
                currentUser = data.user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-screen').classList.remove('hidden');
                document.getElementById('username').textContent = data.user.username.toUpperCase();
                document.getElementById('balance').textContent = `$${data.user.cash.toLocaleString()}`;
                showValues();
            } else {
                alert('‚ùå ' + (data.message || 'Login failed'));
            }
        }

        async function showValues() {
            document.getElementById('values-section').classList.remove('hidden');
            document.getElementById('shop-section').classList.add('hidden');
            document.getElementById('values-tab').style.background = 'linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%)';
            document.getElementById('shop-tab').style.background = 'linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.3) 100%)';
            
            const res = await fetch('/api?action=values');
            const data = await res.json();
            
            const list = document.getElementById('values-list');
            list.innerHTML = '';
            
            data.forEach((item, index) => {
                const change = item.value - item.base_value;
                const changePercent = ((change / item.base_value) * 100).toFixed(1);
                const isPositive = change >= 0;
                const color = isPositive ? 'text-green-400' : 'text-red-400';
                const bgClass = isPositive ? 'value-up' : 'value-down';
                const arrow = isPositive ? '‚Üë' : '‚Üì';
                
                const card = document.createElement('div');
                card.className = `bw-gradient card-hover p-6 rounded-xl ${bgClass} slide-in`;
                card.style.animationDelay = `${index * 0.1}s`;
                card.innerHTML = `
                    <h3 class="text-xl font-bold mb-4 tracking-wide">${item.name}</h3>
                    <p class="text-4xl font-black ${color} mb-3 font-orbitron">$${item.value.toLocaleString()}</p>
                    <div class="flex items-center justify-between">
                        <span class="${color} text-xl font-bold font-orbitron">${arrow} ${Math.abs(changePercent)}%</span>
                        <span class="text-gray-500 text-sm font-semibold">BASE: $${item.base_value.toLocaleString()}</span>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        async function showShop() {
            document.getElementById('values-section').classList.add('hidden');
            document.getElementById('shop-section').classList.remove('hidden');
            document.getElementById('shop-tab').style.background = 'linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%)';
            document.getElementById('values-tab').style.background = 'linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.3) 100%)';
            
            const res = await fetch('/api?action=shop');
            const data = await res.json();
            
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            
            data.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'bw-gradient card-hover p-6 rounded-xl slide-in';
                card.style.animationDelay = `${index * 0.1}s`;
                card.innerHTML = `
                    <h3 class="text-xl font-bold mb-4 tracking-wide">${item.name}</h3>
                    <div class="flex justify-between items-center mb-5">
                        <div>
                            <p class="text-xs text-gray-400 tracking-wide mb-1">STOCK</p>
                            <p class="text-2xl font-bold font-orbitron">${item.stock}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400 tracking-wide mb-1">PRICE</p>
                            <p class="text-3xl font-black font-orbitron">${item.price.toLocaleString()}</p>
                        </div>
                    </div>
                    <button 
                        onclick="openPurchaseModal('${item.name}', ${item.price})" 
                        class="button-shine w-full px-4 py-3 rounded-xl font-bold tracking-wider font-orbitron transition-all duration-300 ${item.stock <= 0 ? 'bg-gray-700/50 cursor-not-allowed' : 'bg-white/15 hover:bg-white/25 border border-white/20 hover:border-white/40'}"
                        ${item.stock <= 0 ? 'disabled' : ''}
                    >
                        ${item.stock <= 0 ? '‚ö†Ô∏è OUT OF STOCK' : '‚úì PURCHASE'}
                    </button>
                `;
                list.appendChild(card);
            });
        }

        function openPurchaseModal(itemName, price) {
            pendingPurchase = { itemName, price };
            document.getElementById('modal-item-name').textContent = itemName;
            document.getElementById('modal-item-price').textContent = `$${price.toLocaleString()}`;
            document.getElementById('purchase-modal').classList.remove('hidden');
            
            // Reset turnstile
            if (window.turnstile) {
                const container = document.getElementById('purchase-turnstile');
                container.innerHTML = '';
                const newDiv = document.createElement('div');
                newDiv.className = 'cf-turnstile';
                newDiv.setAttribute('data-sitekey', '0x4AAAAAACcvzWqePGZJezeH');
                container.appendChild(newDiv);
                window.turnstile.render(newDiv);
            }
        }

        function closePurchaseModal() {
            document.getElementById('purchase-modal').classList.add('hidden');
            pendingPurchase = null;
        }

        async function confirmPurchase() {
            if (!pendingPurchase) return;
            
            const turnstileToken = document.querySelector('#purchase-turnstile [name="cf-turnstile-response"]')?.value;
            
            if (!turnstileToken) {
                alert('‚ö†Ô∏è Please complete verification');
                return;
            }
            
            const res = await fetch('/api?action=purchase', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    polytoria_id: currentUser.user_id,
                    item_name: pendingPurchase.itemName,
                    price: pendingPurchase.price,
                    turnstile_token: turnstileToken
                })
            });
            
            const data = await res.json();
            
            if (data.success) {
                closePurchaseModal();
                alert('‚úÖ PURCHASE SUCCESSFUL!');
                currentUser.cash = data.new_balance;
                document.getElementById('balance').textContent = `$${data.new_balance.toLocaleString()}`;
                showShop();
            } else {
                alert('‚ùå ' + (data.message || 'Purchase failed').toUpperCase());
            }
        }

        // Close modal when clicking outside
        document.getElementById('purchase-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closePurchaseModal();
            }
        });
    </script>
</body>
</html>
