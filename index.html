<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omerta - Values & Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="auth-screen" class="flex items-center justify-center min-h-screen">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-96">
            <h1 class="text-3xl font-bold mb-6 text-center">Omerta</h1>
            <p class="text-gray-400 mb-4 text-center">Please Enter Your Polytoria ID to proceed!</p>
            <input type="number" id="polytoria-id" placeholder="Polytoria User ID" class="w-full px-4 py-2 bg-gray-700 rounded mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="cf-turnstile mb-4" data-sitekey="0x4AAAAAACcvzWqePGZJezeH"></div>
            <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold">Continue</button>
        </div>
    </div>

    <div id="main-screen" class="hidden">
        <nav class="bg-gray-800 p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold">Omerta</h1>
                <div class="flex gap-4">
                    <span id="username" class="text-gray-400"></span>
                    <span id="balance" class="text-green-400"></span>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-4">
            <div class="flex gap-4 mb-6">
                <button onclick="showValues()" class="bg-gray-800 hover:bg-gray-700 px-6 py-2 rounded font-semibold">Values</button>
                <button onclick="showShop()" class="bg-gray-800 hover:bg-gray-700 px-6 py-2 rounded font-semibold">Shop</button>
            </div>

            <div id="values-section" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Item Values</h2>
                <div id="values-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <div id="shop-section" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Shop</h2>
                <div id="shop-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        async function login() {
            const polyId = document.getElementById('polytoria-id').value;
            const turnstileToken = document.querySelector('[name="cf-turnstile-response"]')?.value;
            
            if (!polyId || !turnstileToken) {
                alert('Please complete verification');
                return;
            }
            
            const res = await fetch('/api?action=auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ polytoria_id: polyId, turnstile_token: turnstileToken })
            });
            
            const data = await res.json();
            
            if (data.success) {
                currentUser = data.user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-screen').classList.remove('hidden');
                document.getElementById('username').textContent = `Welcome ${data.user.username}!`;
                document.getElementById('balance').textContent = `$${data.user.cash}`;
                showValues();
            } else {
                alert(data.message || 'Login failed');
            }
        }

        async function showValues() {
            document.getElementById('values-section').classList.remove('hidden');
            document.getElementById('shop-section').classList.add('hidden');
            
            const res = await fetch('/api?action=values');
            const data = await res.json();
            
            const list = document.getElementById('values-list');
            list.innerHTML = '';
            
            data.forEach(item => {
                const change = item.value - item.base_value;
                const changePercent = ((change / item.base_value) * 100).toFixed(1);
                const color = change >= 0 ? 'text-green-400' : 'text-red-400';
                const arrow = change >= 0 ? '↑' : '↓';
                
                list.innerHTML += `
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h3 class="text-xl font-bold">${item.name}</h3>
                        <p class="text-2xl ${color}">$${item.value}</p>
                        <p class="${color}">${arrow} ${Math.abs(changePercent)}%</p>
                    </div>
                `;
            });
        }

        async function showShop() {
            document.getElementById('values-section').classList.add('hidden');
            document.getElementById('shop-section').classList.remove('hidden');
            
            const res = await fetch('/api?action=shop');
            const data = await res.json();
            
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            
            data.forEach(item => {
                list.innerHTML += `
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h3 class="text-xl font-bold">${item.name}</h3>
                        <p class="text-gray-400">Stock: ${item.stock}</p>
                        <p class="text-2xl text-green-400">$${item.price}</p>
                        <button onclick="buyItem('${item.name}', ${item.price})" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                            Buy
                        </button>
                    </div>
                `;
            });
        }

        async function buyItem(itemName, price) {
            const res = await fetch('/api?action=purchase', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    polytoria_id: currentUser.user_id,
                    item_name: itemName,
                    price: price
                })
            });
            
            const data = await res.json();
            
            if (data.success) {
                alert('Successfully Purchased!');
                currentUser.cash = data.new_balance;
                document.getElementById('balance').textContent = `$${data.new_balance}`;
                showShop();
            } else {
                alert(data.message || 'Purchase failed');
            }
        }
    </script>
</body>
</html>
